Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,readmeUrl:null,codeUrl:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred");console.log("_checkChecksum",a);var c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){return text=a.responseText,CHECKSUM&&CHECKSUM!==c._generateChecksum(text)?void b.resolve(!1):void b.resolve(!0)}}),b.promise},afterRender:function(){var a=Rally.getApp();a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})}}),this.callParent(arguments)},_getInformationalHtml:function(){var a="";return this.informationHtml&&(a+=this.informationHtml+"<br/><br/>"),this.readmeUrl&&(a+=Ext.String.format('For details about the data in this app, please refer to the <a href="{0}" target="_blank">README file</a>.<br/><br/>',this.readmeUrl)),this.codeUrl&&(a+=Ext.String.format('Get the code <a href="{0}" target="_blank">here.</a><br/><br/>',this.codeUrl)),a},beforeRender:function(){var a=this._getInformationalHtml();this.callParent(arguments),a&&a.length>0&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:a}),this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"This app was created by the Rally Technical Services Team."}),APP_BUILD_DATE&&this.addDocked({xtype:"container",cls:"build-info",padding:2,html:"Build date/time: "+APP_BUILD_DATE})}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("Rally.technicalservices.Color",{singleton:!0,featureCompleteColor:"#8bbc21",featureCompleteIncompleteDodColor:"#a6c96a",featurePushedColor:"#f28f43",featureTotalColor:"#2f7ed8",featureDeployedColor:"#8085e9",featureNonDeployedColor:"#696969",featurePlanned:"#2f7ed8",featureAdded:"#8bbc21",featureDescoped:"#910000",classificationOnTrack:"green",classificationHighRisk:"red",classificationModerateRisk:"yellow",classificationOther:"#f6f6f6",classificationNotStarted:"#ffffff",classificationCompleted:"#848689",storiesAcceptedCount:"#145499",storiesTotalCount:"#f6f6f6",storiesCommitted:"#8bbc21",storiesNonCommitted:"#f28f43",colors:["#2f7ed8","#8bbc21","#910000","#492970","#f15c80","#7cb5ec","#f28f43","#90ed7d","#434348","#8085e9","#aa1925","#145499","#77a1e5","#c42525","#f7a35c","#a6c96a","#e4d354","#2b908f","#f45b5b","#91e8e1","#1aadce","#4572A7","#AA4643","#89A54E","#80699B","#3D96AE","#DB843D","#92A8CD","#A47D7C","#B5CA92"],colorDisplay:['<span style="color:#2f7ed8">','<span style="color:#8bbc21">','<span style="color:#910000">','<span style="color:#492970">','<span style="color:#f15c80">','<span style="color:#f28f43">','<span style="color:#90ed7d">','<span style="color:#434348">','<span style="color:#8085e9">','<span style="color:#aa1925">','<span style="color:#145499">','<span style="color:#77a1e5">','<span style="color:#c42525">','<span style="color:#f7a35c">','<span style="color:#a6c96a">','<span style="color:#e4d354">','<span style="color:#f45b5b">','<span style="color:#91e8e1">','<span style="color:#1aadce">','<span style="color:#4572A7">','<span style="color:#AA4643">','<span style="color:#89A54E">','<span style="color:#80699B">','<span style="color:#3D96AE">','<span style="color:#DB843D">','<span style="color:#92A8CD">','<span style="color:#A47D7C">','<span style="color:#B5CA92">']}),Ext.define("Rally.technicalservices.MungingToolbox",{singleton:!0,getPieSeriesData:function(a,b){var c=Rally.technicalservices.MungingToolbox.getCountByField(a,b),d=[],e=_.keys(c);return e=Ext.Array.sort(e),_.each(e,function(a){d.push({name:a,y:c[a]||0})}),d},getCountByField:function(a,b){var c={};return _.each(a,function(a){var d=a.get(b);d&&(void 0==c[d]&&(c[d]=0),c[d]++)}),c}}),Ext.define("Rally.technicalservices.DataPopover",{alias:"widget.tsdatapopover",extend:"Rally.ui.dialog.Dialog",id:"grid-popover",cls:"grid-popover",maxWidth:400,maxHeight:300,layout:"fit",autoShow:!0,componentCls:"rly-popover dark-container",header:!0,preventFocusOnActivate:!0,shouldHidePopoverOnBodyClick:!1,shouldHidePopoverOnIframeClick:!1,autoCenter:!1,closable:!0,shadow:!1,target:void 0,targetSelector:void 0,targetTriggeredCls:void 0,owner:void 0,placement:void 0,offsetFromTarget:[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],viewportPadding:[0,0,0,0],targetPosition:["b-t","l-r","t-b","r-l"],chevronPosition:["t-b","r-l","b-t","l-r"],chevronOffset:[{x:0,y:-14},{x:14,y:0},{x:0,y:14},{x:-8,y:0}],showChevron:!0,constructor:function(a){this.title=a.title||"";var b=[];_.each(a.oids,function(a){b.push({property:"ObjectID",value:a})}),b=Rally.data.wsapi.Filter.or(b);var c=Ext.create("Rally.data.wsapi.Store",{model:a.modelName,fetch:a.fetch,enablePostGet:!0,filters:b,pageSize:Math.max(a.oids.length,200),limit:a.oids.length});c.load();var d=[{xtype:"rallygrid",columnCfgs:a.fetch,store:c,showPagingToolbar:a.oids.length>200,showRowActionsColumn:!1,enableBulkEdit:!1}];a.items=Ext.merge(d,a.items),this.callParent(arguments)}}),Ext.define("Rally.technicalservices.LookbackToolbox",{singleton:!0,fetchLookbackSnapshotCount:function(a){var b=Ext.create("Deft.Deferred");return Ext.create("Rally.data.lookback.SnapshotStore",{fetch:["ObjectID"],find:a,limit:1,pageSize:1,removeUnauthorizedSnapshots:!0}).load({callback:function(a,c,d){d?b.resolve(c.resultSet.totalRecords):b.reject(Ext.String.format("Error running lookback query: {0}",c.error.errors.join(",")))}}),b},fetchLookbackRecords:function(a,b,c,d){var e=Ext.create("Deft.Deferred");return b=b||["ObjectID"],c=c||[],d=d||{_ValidFrom:1},Ext.create("Rally.data.lookback.SnapshotStore",{fetch:b,find:a,hydrate:c,limit:1/0,sort:d,removeUnauthorizedSnapshots:!0}).load({callback:function(a,b,c){c?e.resolve(a):e.reject(Ext.String.format("Error running lookback query: {0}",b.error.errors.join(",")))}}),e},fetchLookbackFieldTransitions:function(a,b,c){var d="_PreviousValues."+b;a._ValidFrom={$gte:c},a[d]={$exists:!0},a[d]={$ne:null};var e=["ObjectID",b,d,"_ValidFrom","_SnapshotNumber"];return Rally.technicalservices.LookbackToolbox.fetchLookbackRecords(a,e)},fetchLookbackFieldTransitionsCount:function(a,b,c){var d=Ext.create("Deft.Deferred");return Rally.technicalservices.LookbackToolbox.fetchLookbackFieldTransitions(a,b,c).then({success:function(a){var b=Rally.technicalservices.LookbackToolbox.aggregateSnapsByOidForModel(a);d.resolve(_.keys(b).length)},failure:function(a){d.reject(a)}}),d.promise},fetchLookbackFieldTransitionIntoCount:function(a,b,c,d){var e=Ext.create("Deft.Deferred"),f="_PreviousValues."+b;a._ValidFrom={$gte:c},a[f]={$exists:!0},d instanceof Array?a[b]={$in:d}:a[b]=d;return Rally.technicalservices.LookbackToolbox.fetchLookbackFieldTransitions(a,b,c).then({success:function(a){var b=Rally.technicalservices.LookbackToolbox.aggregateSnapsByOidForModel(a);e.resolve(_.keys(b).length)},failure:function(a){e.reject(a)}}),e.promise},fetchLookbackFieldTransitionOutOfCount:function(a,b,c,d){var e=Ext.create("Deft.Deferred"),f="_PreviousValues."+b;a._ValidFrom={$gte:c},d instanceof Array?a[f]={$in:d}:a[f]=d;return Rally.technicalservices.LookbackToolbox.fetchLookbackFieldTransitions(a,b,c).then({success:function(a){var b=Rally.technicalservices.LookbackToolbox.aggregateSnapsByOidForModel(a);e.resolve(_.keys(b).length)},failure:function(a){e.reject(a)}}),e.promise},aggregateSnapsByOidForModel:function(a){var b={};return Ext.each(a,function(a){var c=a.ObjectID||a.get("ObjectID");void 0==b[c]&&(b[c]=[]),b[c].push(a.getData())}),b},aggregateSnapsByOid:function(a){var b={};return Ext.each(a,function(a){var c=a.ObjectID;void 0==b[c]&&(b[c]=[]),b[c].push(a)}),b}}),Ext.define("Rally.technicalservices.MultiStateComboBox",{alias:"widget.multistatecombo",extend:"Ext.form.FieldContainer",mixins:{field:"Ext.form.field.Field"},cls:"multistate",config:{fieldLabel:"",value:void 0},initComponent:function(){this.callParent(arguments),this.mixins.field.initField.call(this);var a=this;this.add([{xtype:"rallycombobox",name:"statefield",plugins:["rallyfieldvalidationui"],multiSelect:!0,emptyText:"Choose...",displayField:"name",valueField:"value",width:this.width,editable:!1,submitValue:!1,storeType:"Ext.data.Store",storeConfig:{remoteFilter:!1,fields:["name","value"],data:[]},listeners:{change:function(b,c,d){a.state_value=c}}}]),this._loadStates()},_loadStates:function(){Rally.technicalservices.WsapiToolbox.fetchAllowedValues("Defect","State").then({scope:this,success:function(a){var b=Ext.Array.map(a,function(a){return{name:a,value:a}}),c=this.down("rallycombobox");c.getStore().loadData(b);var d=this.getValue();console.log("current values:",d),Ext.isArray(d)||(d=d.split(",")),c.setValue(d),this.fireEvent("ready",this)},failure:function(a){Ext.Msg.alert("Problem Retrieving States",a)}})},getSubmitData:function(){var a={};return a[this.name]=this.state_value,a}}),Ext.define("Rally.technicalservices.WsapiToolbox",{singleton:!0,fetchWsapiCount:function(a,b){var c=Ext.create("Deft.Deferred");Ext.create("Rally.data.wsapi.Store",{model:a,fetch:["ObjectID"],filters:b,limit:1,pageSize:1}).load({callback:function(d,e,f){f?c.resolve(e.resultSet.totalRecords):c.reject(Ext.String.format("Error getting {0} count for {1}: {2}",a,b.toString(),e.error.errors.join(",")))}});return c},fetchWsapiRecords:function(a,b,c){var d=Ext.create("Deft.Deferred");Ext.create("Rally.data.wsapi.Store",{model:a,fetch:c,filters:b,limit:1/0}).load({callback:function(c,e,f){f?d.resolve(c):d.reject(Ext.String.format("Error getting {0} for {1}: {2}",a,b.toString(),e.error.errors.join(",")))}});return d},fetchReleases:function(a){var b=Ext.create("Deft.Deferred"),c=a.getRecord();return null==c&&b.resolve([]),Ext.create("Rally.data.wsapi.Store",{model:"Release",fetch:["ObjectID"],filters:[{property:"Name",value:c.get("Name")},{property:"ReleaseStartDate",value:c.get("ReleaseStartDate")},{property:"ReleaseDate",value:c.get("ReleaseDate")}],limit:1/0}).load({callback:function(a,c,d){d?b.resolve(a):b.reject("Error loading Releases: "+c.error.errors.join(","))}}),b},fetchAllowedValues:function(a,b){var c=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:a,success:function(a){a.getField(b).getAllowedValueStore().load({callback:function(a,b,d){var e=Ext.Array.map(a,function(a){return a.get("StringValue")});c.resolve(e)}})},failure:function(a){c.reject("Error loading field values: "+a)}}),c}}),Ext.define("Rally.TechnicalServices.calculator.FeatureCycleTimeCalculator",{extend:"Rally.data.lookback.calculator.TimeInStateCalculator",config:{devStateNames:["Dev","Test","Deploy","Develop","In-Flight"],closedStateNames:["Done","Operate"],chartType:"column",summaryType:"Summary",projectsByOID:{}},runCalculation:function(a){var b=this,c={};this.startDate=this.startDate||this._getStartDate(a),this.endDate=this.endDate||this._getEndDate(a);var d=Ext.Array.filter(a,function(a){return Ext.Array.contains(b.devStateNames,a.State)});Ext.Array.each(d,function(a){var b=a.ObjectID,d=a._ValidFrom;a.State;c[b]?d<c[b]&&(c[b]=d):c[b]=d});var e=Ext.Array.filter(a,function(a){return Ext.Array.contains(b.closedStateNames,a.State)&&"9999-01-01T00:00:00.000Z"==a._ValidTo}),f={},g=[];Ext.Array.each(e,function(a){var b=c[a.ObjectID],d=Rally.util.DateTime.fromIsoString(a.CreationDate),e=null;Ext.isEmpty(b)?(console.log("No start date, using creation date:",a.FormattedID),b=a.CreationDate,e=d):e=Rally.util.DateTime.fromIsoString(b),a.__start_date=b;var h=Rally.util.DateTime.fromIsoString(a._ValidFrom),i=a.Project.Name;f[i]||(f[i]=[]);var j=Rally.util.DateTime.getDifference(h,e,"hour");a.__cycle=j,console.log("--",a.FormattedID,b,a._ValidFrom,j),g.push(j),f[i].push(a)});var h=[],i=[];if("Summary"==b.summaryType){var j=Ext.Array.mean(g);"day"==b.granularity&&(j/=24),h=[{name:"Average Response Time",data:[j]}],"pie"==b.chartType&&(h=[{type:"pie",data:[["average",j]]}])}else{var k=[];Ext.Object.each(f,function(a,c){if(!Ext.isEmpty(c)){var d=Ext.Array.pluck(c,"__cycle"),e=Ext.Array.mean(d);"day"==b.granularity&&(e/=24),k.push(e),i.push(a)}}),h=[{name:"Average Cycle Time",data:k,options:{series_snapshots:f},point:{events:{click:function(a){b.onPointClick(a,f)}}}}]}return{categories:i,series:h}},onPointClick:function(a){}}),Ext.define("Rally.technicalservices.chart.FeatureCycleTime",{extend:"Ext.panel.Panel",alias:"widget.tsfeaturecycletime",logger:new Rally.technicalservices.Logger,config:{timeboxScope:void 0,context:void 0,summaryType:"Summary"},height:300,border:0,fieldValues:[],constructor:function(a){if(this.mergeConfig(a),this.callParent([this.config]),Ext.isEmpty(this.timeboxScope))throw"("+this.xtype+") Missing required attribute: timeboxScope";if("release"!=this.timeboxScope.type)throw"("+this.xtype+") Timebox scope must be of type 'release'";if(Ext.isEmpty(this.context))throw"("+this.xtype+") Missing required attribute: context"},initComponent:function(){this.callParent(arguments);this.setLoading("Getting valid states...",!0),Ext.isEmpty(this.timeboxScope.getRecord())||(this.startDate=this.timeboxScope.getRecord().get("ReleaseStartDate"),this.endDate=this.timeboxScope.getRecord().get("ReleaseDate")),this.down("#chart_box")||this.add({xtype:"container",itemId:"chart_box",height:this.height-10,minWidth:250}),this.updateChart()},updateTimebox:function(a){this.logger.log("updateTimebox",a),this.timeboxScope=a,Ext.isEmpty(this.timeboxScope.getRecord())||(this.startDate=this.timeboxScope.getRecord().get("ReleaseStartDate"),this.endDate=this.timeboxScope.getRecord().get("ReleaseDate")),this.updateChart()},updateChart:function(){var a=this;a.down("rallychart")&&a.down("rallychart").destroy(),this._getFeaturesInRelease(this.timeboxScope).then({scope:this,success:function(a){var b=Ext.Array.map(a,function(a){return a.get("ObjectID")});this._makeChart(b)},failure:function(a){Ext.Msg.alert("Problem with "+this.xtype,a)}})},_getFeaturesInRelease:function(a){var b=a.getRecord().get("Name"),c="PortfolioItem/Feature",d=["ObjectID"],e=Rally.data.wsapi.Filter.or([{property:"State.Name",value:"Done"},{property:"State.Name",value:"Operate"}]),f=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:b}),g=e.and(f);return Rally.technicalservices.WsapiToolbox.fetchWsapiRecords(c,g,d)},_makeChart:function(a){var b=this;this.down("rallychart")&&this.down("rallychart").destroy(),this.down("#chart_box").removeAll(),this.down("#chart_box").setLoading("Preparing Chart"),this.logger.log("creating chart for start/end:",this.startDate,this.endDate);var c=["#fff"];this.chartType="pie","Summary"!=b.summaryType&&(this.chartType="column",c=["blue"]);var d=this.down("#chart_box").add({xtype:"rallychart",height:this.height-15,loadMask:!1,storeType:"Rally.data.lookback.SnapshotStore",storeConfig:{find:{ObjectID:{$in:a},_TypeHierarchy:"PortfolioItem/Feature",CreationDate:{$lte:Rally.util.DateTime.toIsoString(this.endDate)}},compress:!0,fetch:["State","CreationDate","Project","ObjectID","FormattedID","Name"],hydrate:["State","Project"]},calculatorType:"Rally.TechnicalServices.calculator.FeatureCycleTimeCalculator",calculatorConfig:{trackLastValueForTheseFields:["_ValidTo","_ValidFrom","State"],startDate:b.startDate,endDate:b.endDate,granularity:"day",summaryType:b.summaryType,chartType:b.chartType,onPointClick:b._displayDialogForClick},sort:{_ValidFrom:1},chartConfig:this._getChartConfig(b.summaryType),chartColors:c});d.on("chartRendered",function(){this.down("#chart_box").setLoading(!1)},this)},_getChartConfig:function(a){return"Summary"==a?this._getSummaryChartConfig():this._getTeamChartConfig()},_getSummaryChartConfig:function(){return{chart:{type:"pie"},title:{text:null},xAxis:{labels:{enabled:!1}},legend:{enabled:!1},tooltip:{enabled:!1},yAxis:{title:{text:null},min:0},plotOptions:{pie:{colors:["#fff"],allowPointSelect:!1,dataLabels:{distance:-100,enabled:!0,style:{color:"gray",fontSize:"25px"},formatter:function(){return Ext.util.Format.number(this.y,"0.0")+" Days"}}},column:{marker:{enabled:!1}}}}},_getTeamChartConfig:function(){return{chart:{type:"bar"},title:{text:null},tooltip:{formatter:function(){return Ext.String.format("{0}<br/>{1}: <b>{2}</b>",this.x,this.series.name,Ext.util.Format.number(this.point.y,"0.0"))}},xAxis:{type:"category",labels:{formatter:function(){return Ext.String.format('<span title="{0}">{1}</span>',this.value,Ext.util.Format.ellipsis(this.value,15))}}},yAxis:{title:{text:"Days"}},plotOptions:{bar:{dataLabels:{enabled:!1}}},legend:{enabled:!1}}},_displayDialogForClick:function(a,b){var c=Rally.getApp(),d=a.point,e=d.category,f=b[e];c.logger.log("project snaps",f);var g=Ext.create("Rally.data.custom.Store",{data:f}),h=function(a){return Ext.isEmpty(a)?"":a.replace(/T.*$/,"")},i=function(a){return Ext.isEmpty(a)?"--":Ext.util.Format.number(a/24,"0.0")},j=function(a,b,c){var d={_ref:"/portfolioitem/feature/"+c.get("ObjectID")};return"<a href='"+Rally.nav.Manager.getDetailUrl(d)+"' target='_blank'>"+a+"</a>"};Ext.create("Rally.ui.dialog.Dialog",{id:"detailPopup",title:"Details for "+e,width:Ext.getBody().getWidth()-25,height:Ext.getBody().getHeight()-25,closable:!0,items:[{xtype:"container",layout:{type:"hbox"},items:[{xtype:"container",flex:1}]},{xtype:"rallygrid",sortableColumns:!0,showRowActionsColumn:!1,showPagingToolbar:!1,width:Ext.getBody().getWidth()-27,height:Ext.getBody().getWidth()-25,columnCfgs:[{dataIndex:"FormattedID",text:"id",renderer:j},{dataIndex:"Name",text:"Name",flex:1},{dataIndex:"State",text:"State"},{dataIndex:"__start_date",text:"Start Date",renderer:h},{dataIndex:"_ValidFrom",text:"End Date",renderer:h},{dataIndex:"__cycle",text:"Cycle Time (days)",renderer:i}],store:g}]}).show()}}),Ext.define("TSFeatureCycleTime",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",supportsUnscheduled:!1,componentCls:"app",logger:new Rally.technicalservices.Logger,defaults:{margin:10},config:{defaultSettings:{showOnlyProduction:!1}},layout:{type:"vbox"},timeboxScope:null,onScopeChange:function(a){this.timeboxScope=a,this.down("rallybutton")||this.add({xtype:"rallybutton",text:"Team View",cls:"secondary rly-small",listeners:{scope:this,click:this._updateView}}),this.down("tsfeaturecycletime")?this.down("tsfeaturecycletime").updateTimebox(this.timeboxScope):this._createChart("Summary")},_createChart:function(a){this.down("tsfeaturecycletime")&&this.down("tsfeaturecycletime").destroy(),this.logger.log("width",this.width,this.getWidth()),this.add({xtype:"tsfeaturecycletime",timeboxScope:this.timeboxScope,context:this.getContext(),summaryType:a,width:this.getWidth()-25})},_updateView:function(a){"Team View"==a.text?(a.setText("< Back to Summary"),this._createChart("Team")):(a.setText("Team View"),this._createChart("Summary"))},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{readmeUrl:"https://github.com/RallyTechServices/scrum-team-metrics/blob/master/feature-cycle-time/README.md",codeUrl:"https://github.com/RallyTechServices/scrum-team-metrics/tree/master/feature-cycle-time"})},isExternal:function(){return"undefined"==typeof this.getAppId()},onSettingsUpdate:function(a){this.logger.log("onSettingsUpdate",a),Ext.apply(this,a),this.launch()}});